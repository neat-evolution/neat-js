name: Continuous Integration

on:
  pull_request:

jobs:
  build-test-lint:
    runs-on: ubuntu-latest
    env:
      # Yarn 4 reads auth token from this env var for npm scopes
      YARN_NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - uses: actions/checkout@v6

    - name: Enable Corepack
      run: corepack enable

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'yarn'
        registry-url: "https://npm.pkg.github.com"
        scope: "@neat-evolution"

    - name: Get yarn cache directory
      run: echo "LOOKUP_YARN_CACHE_FOLDER=$(yarn config get cacheFolder)" >> $GITHUB_ENV

    - name: Cache TurboRepo
      uses: actions/cache@v4
      with:
        path: |
          .turbo
          ${{ env.LOOKUP_YARN_CACHE_FOLDER }}
          node_modules
        key: ${{ runner.os }}-turbo-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-turbo-

    - name: Install dependencies (yarn)
      run: yarn install --immutable --refresh-lockfile

    - name: Build (all)
      run: yarn build

    # TODO: run in parallel to tests
    - name: Lint (all)
      run: yarn lint

    - name: Test (all)
      run: yarn test

    - name: Check packages (manypkg)
      run: yarn check:manypkg

    - name: Check change files (beachball)
      run: yarn check:beachball
